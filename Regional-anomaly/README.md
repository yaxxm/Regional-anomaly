# 用户级别异常区域检测

## 项目概述

本项目实现了一个完整的Python脚本，用于从用户级别的应用使用数据中检测异常区域。通过聚合用户数据生成区域级别的特征，然后使用孤立森林模型识别出表现异常的区域。

## 功能特点

- 从用户-应用级别数据聚合生成区域级别特征
- 使用孤立森林算法检测异常区域
- 提供详细的异常分析结果
- 生成多种可视化图表辅助分析
- 导出分析结果到CSV文件

## 数据要求

原始数据应保存在`data2_extended.csv`文件中，以用户-应用记录为单位，包含以下列（或类似列名）：
- `imei`: 设备唯一标识符
- `app_id`: 应用ID
- `user_region`: 用户所在区域
- `cpu_average_pct`: CPU平均使用率
- `cpu_peak_pct`: CPU峰值使用率
- `foreground_minutes`: 前台使用时长（分钟）
- `background_minutes`: 后台运行时长（分钟）
- `download_date`: 下载日期
- `uninstall_date`: 卸载日期（可能包含空值）
- `alive_days`: 应用存活天数

## 实现步骤

### 第一部分：加载和预处理用户级别数据

1. 加载数据：使用pandas将`data2_extended.csv`读入DataFrame
2. 数据清洗与转换：
   - 将日期列转换为datetime对象
   - 确保数值列为正确的数值类型
   - 处理缺失值（对于时长或CPU使用率使用0填充，对于alive_days使用中位数填充）
3. 计算辅助列：
   - `is_uninstalled`: 根据`uninstall_date`是否为空创建的布尔值列
   - `background_time_ratio`: 计算后台时间占比，处理分母为0的情况

### 第二部分：计算并聚合生成区域级别特征

根据特征表，为每个`user_region`计算以下区域级别特征：

1. `区域_最大后台CPU使用率`: 该区域内所有App中，单个App后台CPU平均使用率的最大值
2. `区域_平均后台CPU使用率`: 该区域内所有App后台CPU平均使用率的均值
3. `区域_后台CPU超阈值App占比`: 该区域内，后台CPU平均使用率超过预设阈值的App数量占比
4. `区域_最大峰值CPU使用率`: 该区域内所有App中，单个App峰值CPU使用率的最大值
5. `区域_最大后台时间占比`: 该区域内所有App中，单个App的后台时间占比的最大值
6. `区域_平均后台时间占比`: 该区域内所有App的后台时间占比的平均值
7. `区域_后台时间占比超阈值App数`: 该区域内，后台时间占比超过预设阈值的App数量
8. `区域_平均前台使用时长`: 该区域内所有App的平均前台使用时长
9. `区域_最高卸载率App`: 该区域内所有App中，单个App的卸载率的最大值
10. `区域_平均卸载率`: 该区域内所有App卸载率的平均值
11. `区域_短期卸载App占比`: 该区域内，下载后短时间即卸载的App占比
12. `区域_高后台CPU且高后台时间占比App数`: 该区域内，同时满足后台CPU超阈值和后台时间占比超阈值的App数量
13. `区域_调度次数特征`: 该区域内App的平均/最大前后台调度次数或调度频率（如果原始数据中没有相关字段，则使用0作为占位符）

### 第三部分：使用孤立森林进行异常区域检测

1. 准备建模数据：从区域级别特征中提取用于建模的数值特征列
2. 处理缺失值：确保区域级别特征中没有NaN值
3. 初始化并训练模型：使用IsolationForest，设置contamination=0.05和random_state=42
4. 预测异常：对区域特征数据进行预测，得到每个区域的异常标签和异常分数

### 第四部分：结果分析与可视化

1. 统计异常和正常区域数量
2. 显示异常区域详情
3. 生成多种可视化图表：
   - 异常分数分布图
   - 异常区域特征热力图
   - 区域异常检测散点图
   - 特征重要性排序图
4. 导出分析结果到CSV文件

## 使用方法

1. 确保原始数据文件`data2_extended.csv`位于正确路径下
2. 运行脚本：
   ```bash
   python 用户级别异常区域检测.py
   ```
3. 查看输出结果：
   - 控制台输出：包含数据加载信息、特征计算过程、异常检测结果统计和异常区域详情
   - 输出目录：包含可视化图表和CSV结果文件

## 参数设置

脚本中使用了以下关键参数：

- `CPU_THRESHOLD = 20`：后台CPU使用率阈值（百分比）
- `BG_RATIO_THRESHOLD = 0.70`：后台时间占比阈值（70%）
- `SHORT_UNINSTALL_DAYS = 2`：短期卸载天数阈值
- `contamination = 0.05`：孤立森林模型中的异常比例参数（预估5%的异常区域）

## 输出结果

脚本执行完成后，将在输出目录中生成以下文件：

1. `异常分数分布.png`：展示所有区域的异常分数分布
2. `异常区域特征热力图.png`：展示异常区域各特征的归一化值
3. `区域异常检测散点图.png`：使用两个重要特征展示区域分布情况
4. `特征重要性排序.png`：展示各特征对异常检测的重要性排序
5. `异常检测结果.csv`：包含所有区域的特征和异常检测结果
6. `异常区域详情.csv`：仅包含被标记为异常的区域的详细信息

## 注意事项

- 脚本假设原始数据中的CPU指标可以代表应用活跃期间的CPU消耗
- 如果原始数据中没有调度次数相关字段，该特征将使用0作为占位符
- 对于分母可能为0的计算（如后台时间占比），脚本进行了特殊处理以避免除零错误
- 数据集已扩充至1000条记录，提供了更全面的样本进行异常检测


# 地区级别异常检测与大模型智能分析

## 大模型推理分析流程

本项目集成了基于大模型的异常区域智能分析，自动读取异常检测结果，并利用大模型对每个地区的性能指标进行详细解释和专业分析。

### 主要流程
1. 运行异常检测脚本，生成地区级别的异常检测结果（如`输出结果/异常检测结果.csv`）。
2. 运行大模型推理脚本，对检测结果进行逐地区分析，输出详细的异常原因解释。

### 大模型推理脚本说明

脚本位置：`大模型推理代码/predict.py`

#### 输入文件
- `输出结果/异常检测结果.csv`：包含各地区的性能指标、异常分数和系统判定结果。

#### 输出文件
- `大模型推理结果/result.csv`：每个地区的异常分数、是否异常及大模型详细分析（多行分项解释，便于阅读）。
- `大模型推理结果/result.json`：原始JSON结构，保留完整换行和分项分析内容。

#### 运行方法
```bash
python 大模型推理代码/predict.py
```

#### 结果解读
- `result.csv`文件每行包含：地区、异常分数、是否异常、分析结果（多行分项解释每个性能指标的异常与否及原因）。
- `result.json`文件保留了原始结构和换行，适合程序化处理或进一步分析。

#### 分析内容示例
```
地区: 北京
异常分数: -0.002
是否异常: 异常
分析结果:
1. CPU使用情况分析：
   - 最大后台CPU使用率分析：
     北京地区的最大后台CPU使用率为17.50%，这个值处于较低水平，通常后台CPU使用率在15%到20%之间被认为是正常的。因此，这个指标没有显示出异常情况。
   - 平均后台CPU使用率分析：
     平均后台CPU使用率为16.78%，这个值同样处于正常范围内，表明系统的后台处理能力较为均衡。
   ...
```

### 注意事项
- 若需自定义分析指标或输出格式，可修改`predict.py`中的相关逻辑。
- 大模型分析结果已优化为每项单独换行，便于人工查阅和自动化处理。